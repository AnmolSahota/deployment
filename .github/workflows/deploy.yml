name: CI/CD Deployment

# Trigger workflow on push to master branch
on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Deploy to EC2 via SSH
      - name: Deploy Dockerized MERN App to EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 IP
          username: ${{ secrets.EC2_USER }} # EC2 SSH user
          key: ${{ secrets.EC2_KEY }} # EC2 private key
          script: |
            # Navigate to deployment folder on EC2
            cd /home/ubuntu/www/deployment

            # Pull latest code
            git reset --hard
            git pull origin master

            # -----------------------------
            # Backend: build and run Docker
            # -----------------------------
            cd server 
            sudo docker build -t backend .
            sudo docker stop backend || true
            sudo docker rm backend || true
            sudo docker run -d -p 5000:5000 --name backend backend

            # -----------------------------
            # Frontend: build and run Docker
            # -----------------------------
            cd ../client
            sudo docker build -t frontend .
            sudo docker stop frontend || true
            sudo docker rm frontend || true
            sudo docker run -d -p 3000:80 --name frontend frontend
